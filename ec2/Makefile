# EC2 åˆ†å¸ƒå¼éƒ¨ç½² Makefile
SSH_KEY = ~/.ssh/xrui.pem


# ä» hosts.txt è‡ªåŠ¨è§£æå‡º node0~3 çš„å…¬ç½‘ IP åˆ—è¡¨
NODES := $(shell grep -E 'node[0-9]+$$' hosts.txt | awk '{print "ubuntu@"$$1}')
NODE0 := $(shell awk '$$2=="node0" {print "ubuntu@"$$1}' hosts.txt)
# ä» hosts.txt è‡ªåŠ¨è§£æå‡º client çš„å…¬ç½‘ IP
CLIENT := $(shell grep -E 'client$$' hosts.txt | awk '{print "ubuntu@"$$1}')
# ä» hosts.txt è‡ªåŠ¨è§£æå‡ºæ‰€æœ‰å…¬ç½‘ IP
HOST_IPS := $(shell grep -v private hosts.txt | awk '{print $$1}')

SSH_OPTS = -i $(SSH_KEY) -o StrictHostKeyChecking=accept-new -o BatchMode=yes -o ConnectTimeout=8


.PHONY: init deploy start stop logs known_hosts ping hosts-clean clean-ec2 clean

known_hosts:
	@echo "ğŸ” åˆå§‹åŒ– known_hosts..."
	@ssh-keyscan -H $(HOST_IPS) >> $$HOME/.ssh/known_hosts 2>/dev/null || true
	@echo "âœ… known_hosts å·²æ›´æ–°"

ping:
	@for host in $(NODES) $(CLIENT); do \
	  echo "â†ªï¸ æµ‹è¯• $$host"; \
	  ssh $(SSH_OPTS) $$host 'echo OK' || echo "âŒ $$host è¿æ¥å¤±è´¥"; \
	done

init:
	@bash init-ec2.sh

deploy:
	@/opt/homebrew/bin/bash deploy-ec2.sh


pull:
	@echo "ğŸš€ æ‹‰å–èŠ‚ç‚¹ä¸å®¢æˆ·ç«¯é•œåƒ..."
	@for node in $(NODES); do \
		echo "ğŸ”¸ æ‹‰å– $${node} ä¸Šçš„ hotstuff-node é•œåƒ..."; \
		ssh $(SSH_OPTS) $${node} "cd ~/hotstuff && docker compose pull hotstuff-node" || true; \
	done; \
	wait
	@echo "ğŸ”¸ æ‹‰å–å®¢æˆ·ç«¯é•œåƒ ($(CLIENT)) ..."
	@ssh $(SSH_OPTS) $(CLIENT) "cd ~/hotstuff && docker compose pull hotstuff-client" || true
	@echo "âœ… é•œåƒæ‹‰å–å®Œæˆ âœ…"

start: 
	@echo "ğŸš€ å¯åŠ¨å®éªŒ..."
	@status=0; pids=""; \
	for node in $(NODES); do \
		( \
			ssh $(SSH_OPTS) $${node} "cd ~/hotstuff && docker compose --profile consensus up -d" \
		) & \
		pids="$$pids $$!"; \
	done; \
	for pid in $$pids; do \
		if ! wait $$pid; then status=1; fi; \
	done; \
	if [ $$status -ne 0 ]; then \
		echo "âŒ å¯åŠ¨å…±è¯†èŠ‚ç‚¹å¤±è´¥"; \
		exit 1; \
	fi
	@sleep 15
	@ssh $(SSH_OPTS) $(CLIENT) "cd ~/hotstuff && docker compose --profile client up -d || docker-compose --profile client up -d" || { echo "âŒ å¯åŠ¨å®¢æˆ·ç«¯å¤±è´¥"; exit 1; }
	@echo "âœ… å®éªŒå¯åŠ¨å®Œæˆ"
	@echo "â±ï¸ ç­‰å¾… 2 åˆ†é’Ÿåè‡ªåŠ¨åœæ­¢å®éªŒ..."
	@sleep 150
	@$(MAKE) stop


stop:
	@echo "ğŸ›‘ åœæ­¢å®éªŒ..."
	@status=0; pids=""; \
	for node in $(NODES); do \
		echo "â†’ $$node"; \
		( \
			ssh $(SSH_OPTS) $$node "cd ~/hotstuff && (docker compose --profile consensus down || docker-compose --profile consensus down)" \
		) & \
		pids="$$pids $$!"; \
	done; \
	for pid in $$pids; do \
		if ! wait $$pid; then status=1; fi; \
	done; \
	if [ $$status -ne 0 ]; then \
		echo "âŒ åœæ­¢å…±è¯†èŠ‚ç‚¹å¤±è´¥"; \
		exit 1; \
	fi
	@ssh $(SSH_OPTS) $(CLIENT) "cd ~/hotstuff && (docker compose --profile client down || docker-compose --profile client down)" || { echo "âŒ åœæ­¢å®¢æˆ·ç«¯å¤±è´¥"; exit 1; }
	@echo "âœ… å®éªŒåœæ­¢å®Œæˆ, å‡†å¤‡æ”¶é›†æ—¥å¿—"
	@$(MAKE) logs

logs:
	@echo "ğŸ“¦ æ”¶é›†æ—¥å¿—..."
	@mkdir -p ec2-logs
	@status=0; pids=""; \
	for node in $(NODES); do \
		host=$${node##*@}; \
		( scp $(SSH_OPTS) -r $$node:~/hotstuff/logs/* ./ec2-logs/logs-$$host ) & \
		pids="$$pids $$!"; \
	done; \
	( scp $(SSH_OPTS) -r $(CLIENT):~/hotstuff/logs ./ec2-logs/logs-client ) & \
	pids="$$pids $$!"; \
	for pid in $$pids; do \
		if ! wait $$pid; then status=1; fi; \
	done; \
	if [ $$status -ne 0 ]; then \
		echo "âŒ æ—¥å¿—æ”¶é›†å¤±è´¥"; \
		exit 1; \
	fi
	@echo "âœ… æ—¥å¿—æ”¶é›†å®Œæˆ"
	@$(MAKE) clean

logs-core:
	@echo "ğŸ“¦ æ”¶é›† node0 ä¸ client æ—¥å¿—..."
	@mkdir -p ec2-logs
	@status=0; pids=""; \
	node="$(NODE0)"; \
	if [ -n "$$node" ]; then \
		host=$${node##*@}; \
		( scp $(SSH_OPTS) -r $$node:~/hotstuff/logs/* ./ec2-logs/logs-$$host ) & \
		pids="$$pids $$!"; \
	else \
		echo "âš ï¸ æœªæ‰¾åˆ° node0 å…¬ç½‘åœ°å€ï¼Œè·³è¿‡èŠ‚ç‚¹æ—¥å¿—æ”¶é›†"; \
	fi; \
	( scp $(SSH_OPTS) -r $(CLIENT):~/hotstuff/logs ./ec2-logs/logs-client ) & \
	pids="$$pids $$!"; \
	for pid in $$pids; do \
		if ! wait $$pid; then status=1; fi; \
	done; \
	if [ $$status -ne 0 ]; then \
		echo "âŒ æ ¸å¿ƒæ—¥å¿—æ”¶é›†å¤±è´¥"; \
		exit 1; \
	fi
	@echo "âœ… æ ¸å¿ƒæ—¥å¿—æ”¶é›†å®Œæˆ"

hosts-clean:
	@echo "ğŸ” æ¸…ç†æ—§ known_hosts è®°å½•ï¼ˆä»…é™ EC2 IPï¼‰..."
	@for ip in $$(awk '{print $$1}' hosts.txt | grep -E '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$$'); do \
		ssh-keygen -R $$ip >/dev/null 2>&1; \
	done
	@echo "âœ… EC2 IP å·²æ¸…ç†å®Œæ¯•"

clean:
	@echo "ğŸ§¹ å¼€å§‹æ¸…ç† log..."
	@for ip in $$(awk '{if ($$1 !~ /^172\./ && ($$2 ~ /^node/ || $$2 ~ /^client/)) print $$1}' hosts.txt); do \
		( \
			echo "â†’ æ¸…ç† $$ip ..."; \
			if ssh $(SSH_OPTS) ubuntu@$$ip "sudo rm -rf ~/hotstuff/logs/*"; then \
				echo "âœ… $$ip æ¸…ç†å®Œæˆ"; \
			else \
				echo "âš ï¸ $$ip æ¸…ç†å¤±è´¥"; \
			fi \
		) & \
	done; \
	wait
	@echo "âœ… æ¸…ç†å®Œæˆ"

clean-ec2:
	@echo "ğŸ§¹ å¼€å§‹æ¸…ç† EC2 èŠ‚ç‚¹æ•°æ®ï¼ˆä»…å…¬ç½‘IPï¼‰..."
	@for ip in $$(awk '{if ($$1 !~ /^172\./ && ($$2 ~ /^node/ || $$2 ~ /^client/)) print $$1}' hosts.txt); do \
		echo "â†’ æ¸…ç† $$ip ..."; \
		ssh $(SSH_OPTS) ubuntu@$$ip "sudo rm -rf ~/hotstuff" || echo "âš ï¸ $$ip æ¸…ç†å¤±è´¥"; \
	done
	@echo "âœ… æ¸…ç†å®Œæˆ"

clean-images:
	@echo "ğŸ§¼ æ¸…ç† EC2 èŠ‚ç‚¹ä¸Šçš„æ—§é•œåƒ..."
	@for node in $(NODES) $(CLIENT); do \
		( \
			echo "â†’ $$node"; \
			if ssh $(SSH_OPTS) $$node "docker system prune -a -f --volumes"; then \
				echo "âœ… $$node é•œåƒæ¸…ç†å®Œæˆ"; \
			else \
				echo "âš ï¸ $$node é•œåƒæ¸…ç†å¤±è´¥"; \
			fi \
		) & \
	done; \
	wait
	@echo "âœ… é•œåƒæ¸…ç†å®Œæˆ"
