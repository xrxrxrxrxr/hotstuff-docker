# version: '3.8'

services:
  hotstuff-node:
    image: georgiaxr/hs-test:latest
    container_name: hotstuff_node${NODE_ID}
    hostname: node${NODE_ID}
    network_mode: host  
    environment:
      - NODE_ID=${NODE_ID}
      - NODE_LEAST_ID=${NODE_LEAST_ID}
      - NODE_NUM=${NODE_NUM}
      - NODE_PORT=${NODE_PORT}
      - NODE_HOSTS=${NODE_HOSTS}
      - POMPE_ENABLE=${POMPE_ENABLE}
      - POMPE_BATCH_SIZE=${POMPE_BATCH_SIZE}
      - POMPE_STABLE_PERIOD_MS=${POMPE_STABLE_PERIOD_MS}
      - POMPE_LEADER_NODE_ID=${POMPE_LEADER_NODE_ID}
      - POMPE_LIVENESS_DELTA_MS=${POMPE_LIVENESS_DELTA_MS}
      - SMROL_PNFIFO_THRESHOLD=${SMROL_PNFIFO_THRESHOLD}
      - SMROL_DISABLE_THRESHOLD_SIG=${SMROL_DISABLE_THRESHOLD_SIG}
      - RUST_LOG=${RUST_LOG}
      - SMROL_DISABLE_METRICS=${SMROL_DISABLE_METRICS}
      - METRICS_LISTEN_ADDR=0.0.0.0:9900
    volumes:
      - ./logs:/logs
      - ./logs:/log
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "nc", "-z", "127.0.0.1", "10000"]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 20s
    profiles:
      - consensus
